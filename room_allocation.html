<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Allocation System - Smart Hostel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <img src="images/warden-photo.jpg" alt="Warden Profile">
            <div class="brand-text"><h3>Warden Panel</h3><p>Smart Hostel</p></div>
        </div>
        <ul class="nav-links">
            <li><a href="index.html"><i class="fas fa-th-large"></i> Dashboard</a></li>
            <li><a href="view_student.html"><i class="fas fa-users"></i> View Student</a></li>
            <li><a href="attendance.html"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
            <li class="active"><a href="room_allocation.html"><i class="fas fa-door-open"></i> Room Allocation</a></li>
            <li><a href="account.html"><i class="fas fa-user"></i> Account</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Setting</a></li>
        </ul>
        <div class="logout-container">
            <a href="#" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    <div class="main-content">
        <header class="allocation-header">
            <div class="header-left">
                <h1>Room Allocation System</h1>
                <p>Visual bed allocation with real-time availability</p>
            </div>
            <div class="header-right">
                <div class="unallocated-badge">
                    <span>Unallocated</span>
                    <strong id="unallocated-count">0</strong>
                </div>
                <div class="view-toggles">
                    <button class="toggle-btn" onclick="addNewStudent()" style="background: #2ecc71; color: white;">
    <i class="fas fa-user-plus"></i> Add Student
</button>
                    <button class="toggle-btn" onclick="switchView('list')"><i class="fas fa-list"></i> List View</button>
                </div>
            </div>
        </header>

        <div class="floor-tabs">
            <button class="floor-tab active" onclick="changeFloor(1, this)">Floor 1</button>
            <button class="floor-tab" onclick="changeFloor(2, this)">Floor 2</button>
            <button class="floor-tab" onclick="changeFloor(3, this)">Floor 3</button>
            <button class="floor-tab" onclick="changeFloor(4, this)">Floor 4</button>
        </div>

        <div class="summary-cards">
            <div class="stat-card green"><h3 id="stat-total">0</h3><p>Total Rooms</p></div>
            <div class="stat-card red"><h3 id="stat-empty">0</h3><p>Empty</p></div>
            <div class="stat-card yellow"><h3 id="stat-partial">0</h3><p>Partially Filled</p></div>
            <div class="stat-card blue"><h3 id="stat-full">0</h3><p>Full</p></div>
            <div class="stat-card orange"><h3 id="stat-beds">0</h3><p>Available Beds</p></div>
        </div>

        <div class="allocation-filter-bar">
            <div class="legend">
                <span class="legend-item"><i class="fas fa-circle occupied"></i> Occupied Bed</span>
                <span class="legend-item"><i class="fas fa-plus-circle available"></i> Available Bed (Click to Allocate)</span>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="mainSearch" placeholder="Search by Room Number or Student Name..." oninput="renderRooms()">
            </div>
        </div>

        <div id="floorPlanView" class="view-section">
            <div class="room-grid" id="roomGrid">
                </div>
        </div>

        <div id="listView" class="view-section" style="display: none;">
            <div class="table-container">
                <table class="allocation-table">
                    <thead>
                        <tr>
                            <th>ROOM NO</th>
                            <th>TYPE</th>
                            <th>FLOOR</th>
                            <th>RESIDENTS</th>
                            <th>OCCUPANCY</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="listTableBody">
                        <tr>
                            <td colspan="6" style="text-align:center; padding: 20px;">Use Floor Plan to Allocate Beds</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="allocationModal" class="modal">
        <div class="modal-content allocation-modal-layout">
            <div class="modal-header teal-bg">
                <div class="header-info">
                    <h2>Allocate Student to Bed</h2>
                    <p><i class="fas fa-bed"></i> Room <span id="mRoomNo">--</span></p>
                </div>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="student-selection" id="unallocatedList">
                    </div>
                <button class="confirm-btn" onclick="confirmAllocation()">Confirm Allocation</button>
            </div>
        </div>
    </div>
<script>
    // 1. DATA STATE
    let allRooms = [
        // Floor 1: 3 Rooms
        { no: "01", type: "QUAD", floor: 1, capacity: 4, residents: ["John Smith"] },
        { no: "02", type: "QUAD", floor: 1, capacity: 4, residents: [] },
        { no: "03", type: "DOUBLE", floor: 1, capacity: 2, residents: [] },
        // Other Floors: 1 Room each
        { no: "04", type: "SINGLE", floor: 2, capacity: 1, residents: [] },
        { no: "05", type: "DOUBLE", floor: 3, capacity: 2, residents: [] },
        { no: "06", type: "QUAD", floor: 4, capacity: 4, residents: [] }
    ];

    let unallocatedStudents = [
        { id: "STU005", name: "David Wilson", dept: "Law" },
        { id: "STU006", name: "Lisa Anderson", dept: "Psychology" }
    ];

    let currentFloor = 1;
    let selectedRoom = null;
    let selectedStudent = null;

    // 2. RENDER LOGIC
    function renderRooms() {
        const grid = document.getElementById('roomGrid');
        const query = document.getElementById('mainSearch').value.toLowerCase();
        grid.innerHTML = '';

        const filtered = allRooms.filter(room => {
            const matchesFloor = room.floor === currentFloor;
            const matchesQuery = room.no.includes(query) || 
                                 room.residents.some(r => r.toLowerCase().includes(query));
            return matchesFloor && matchesQuery;
        });

        filtered.forEach(room => {
            let bedsHTML = '';
            for (let i = 0; i < room.capacity; i++) {
                if (i < room.residents.length) {
                    bedsHTML += `<div class="bed-icon occupied"><i class="fas fa-user"></i></div>`;
                } else {
                    bedsHTML += `<div class="bed-icon available" onclick="openModal('${room.no}')"><i class="fas fa-plus"></i></div>`;
                }
            }

            // Updated resident list with Delete (Trash) icons
            const residentsListHTML = room.residents.length > 0 
                ? `<ul>
                    ${room.residents.map(r => `
                        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span><i class="fas fa-user-circle"></i> ${r}</span>
                            <i class="fas fa-trash-alt" 
                               style="color: #ff4d4d; cursor: pointer; font-size: 0.9em;" 
                               onclick="removeStudent('${room.no}', '${r}')" 
                               title="Remove Student"></i>
                        </li>
                    `).join('')}
                   </ul>` 
                : `<p class="empty-msg">No residents</p>`;

            grid.innerHTML += `
                <div class="room-card">
                    <div class="room-card-header">
                        <div class="room-title"><h3>Room ${room.no}</h3><span>${room.type} â€¢ Floor ${room.floor}</span></div>
                        <div class="occupancy-ratio"><span class="count">${room.residents.length}/${room.capacity}</span></div>
                    </div>
                    <div class="bed-status-container">
                        <p class="section-label">Bed Status:</p>
                        <div class="bed-icons">${bedsHTML}</div>
                    </div>
                    <div class="resident-list">
                        <p class="section-label">Current Residents:</p>
                        ${residentsListHTML}
                    </div>
                </div>`;
        });
        updateStats();
    }

    // 3. STUDENT REMOVAL LOGIC
    function removeStudent(roomNo, studentName) {
    if(!confirm(`Are you sure you want to remove ${studentName} from Room ${roomNo}?`)) return;

    const room = allRooms.find(r => r.no === roomNo);
    
    // FIX: Add the student back to the unallocated list so they appear in the "Add" modal
    unallocatedStudents.push({ 
        id: "STU-" + Math.floor(Math.random() * 1000), 
        name: studentName, 
        dept: "Returned" 
    });

    room.residents = room.residents.filter(resident => resident !== studentName);

    renderRooms(); // This will also call updateStats() to show the new count
}

    // 4. NAVIGATION & VIEW SWITCHING
    function changeFloor(floor, btn) {
        currentFloor = floor;
        document.querySelectorAll('.floor-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        renderRooms();
    }

    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(section => {
            section.style.display = 'none';
        });
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));

        if (view === 'plan') {
            document.getElementById('floorPlanView').style.display = 'block';
            document.querySelector('button[onclick="switchView(\'plan\')"]').classList.add('active');
        } else {
            document.getElementById('listView').style.display = 'block';
            document.querySelector('button[onclick="switchView(\'list\')"]').classList.add('active');
        }
    }

    function updateStats() {
        document.getElementById('stat-total').innerText = allRooms.length;
        document.getElementById('stat-empty').innerText = allRooms.filter(r => r.residents.length === 0).length;
        document.getElementById('stat-partial').innerText = allRooms.filter(r => r.residents.length > 0 && r.residents.length < r.capacity).length;
        document.getElementById('stat-full').innerText = allRooms.filter(r => r.residents.length === r.capacity).length;
        
        const availableBeds = allRooms.reduce((acc, room) => acc + (room.capacity - room.residents.length), 0);
        document.getElementById('stat-beds').innerText = availableBeds;
        
        document.getElementById('unallocated-count').innerText = unallocatedStudents.length;
    }

    // 5. MODAL LOGIC
    function openModal(roomNo) {
        selectedRoom = roomNo;
        document.getElementById('mRoomNo').innerText = roomNo;
        
        const list = document.getElementById('unallocatedList');
        list.innerHTML = `<p class="section-label">Select Student (${unallocatedStudents.length} available)</p>`;
        
        if(unallocatedStudents.length === 0) {
             list.innerHTML += `<p style="padding:10px; color:#666;">No unallocated students found.</p>`;
        } else {
            unallocatedStudents.forEach(student => {
                list.innerHTML += `
                    <div class="student-item" onclick="selectStudentForAlloc(this, '${student.name}')">
                        <div class="s-info"><strong>${student.name}</strong><span>${student.id}</span></div>
                        <i class="fas fa-check-circle"></i>
                    </div>`;
            });
        }
        document.getElementById('allocationModal').style.display = 'flex';
    }

    function selectStudentForAlloc(el, name) {
        document.querySelectorAll('.student-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        selectedStudent = name;
    }

    function confirmAllocation() {
        if (!selectedStudent) return alert("Select a student!");
        
        const room = allRooms.find(r => r.no === selectedRoom);
        room.residents.push(selectedStudent);
        unallocatedStudents = unallocatedStudents.filter(s => s.name !== selectedStudent);

        closeModal();
        renderRooms();
        selectedStudent = null;
    }

    function addNewStudent() {
    const name = prompt("Enter Student Name:");
    const id = prompt("Enter Student ID (e.g., STU007):");
    const dept = prompt("Enter Department:");

    if (name && id) {
        // This adds the new student to your "Master List" of waiting students
        unallocatedStudents.push({
            id: id,
            name: name,
            dept: dept || "General"
        });

        // Update the little green "Unallocated" badge at the top
        updateStats();
        
        alert(name + " added to the waiting list!");
    }
}

    function closeModal() { document.getElementById('allocationModal').style.display = 'none'; }

    // Init
    window.onload = renderRooms;
    
</script>
</body>
</html>